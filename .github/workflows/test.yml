name: 🧪 Test

on:
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: lugx-cluster-man
  EKS_NAMESPACE: lux-gaming

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: 📦 Install dependencies
      run: |
        echo "Installing dependencies for all services..."
        
        # Install user service dependencies
        cd lugx-backend/services/user
        npm ci || npm install
        cd ../..
        
        # Install game service dependencies
        cd lugx-backend/services/game
        npm ci || npm install
        cd ../..
        
        # Install order service dependencies
        cd lugx-backend/services/order
        npm ci || npm install
        cd ../..
        
        # Install analytics service dependencies
        cd lugx-backend/services/analytics
        npm ci || npm install
        cd ../..
        
    - name: 🧪 Run tests
      run: |
        echo "Running tests for all services..."
        
        # Test user service
        cd lugx-backend/services/user
        npm test || echo "User service tests failed"
        cd ../..
        
        # Test game service
        cd lugx-backend/services/game
        npm test || echo "Game service tests failed"
        cd ../..
        
        # Test order service
        cd lugx-backend/services/order
        npm test || echo "Order service tests failed"
        cd ../..
        
        # Test analytics service
        cd lugx-backend/services/analytics
        npm test || echo "Analytics service tests failed"
        cd ../..
        
    - name: 🔍 Lint code
      run: |
        echo "Running linting for all services..."
        
        # Lint user service
        cd lugx-backend/services/user
        npm run lint || echo "User service linting failed"
        cd ../..
        
        # Lint game service
        cd lugx-backend/services/game
        npm run lint || echo "Game service linting failed"
        cd ../..
        
        # Lint order service
        cd lugx-backend/services/order
        npm run lint || echo "Order service linting failed"
        cd ../..
        
        # Lint analytics service
        cd lugx-backend/services/analytics
        npm run lint || echo "Analytics service linting failed"
        cd ../..
        
    - name: 🐳 Build Docker images (without pushing)
      uses: docker/setup-buildx-action@v3
      
    - name: 🔐 Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: 🏗️ Build Frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./lux-frontend
        push: false
        tags: rajithawan/lugx-frontend-image:test
        platforms: linux/amd64
        
    - name: 🏗️ Build User Service image
      uses: docker/build-push-action@v5
      with:
        context: ./lugx-backend/services/user
        push: false
        tags: rajithawan/lugx-user-image:test
        platforms: linux/amd64
        
    - name: 🏗️ Build Game Service image
      uses: docker/build-push-action@v5
      with:
        context: ./lugx-backend/services/game
        push: false
        tags: rajithawan/lugx-game-image:test
        platforms: linux/amd64
        
    - name: 🏗️ Build Order Service image
      uses: docker/build-push-action@v5
      with:
        context: ./lugx-backend/services/order
        push: false
        tags: rajithawan/lugx-order-image:test
        platforms: linux/amd64
        
    - name: 🏗️ Build Analytics Service image
      uses: docker/build-push-action@v5
      with:
        context: ./lugx-backend/services/analytics
        push: false
        tags: rajithawan/lugx-analytics-image:test
        platforms: linux/amd64
        
    - name: ✅ Test Summary
      if: always()
      run: |
        echo "## 🧪 Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✅ Tests Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- Unit tests for all services" >> $GITHUB_STEP_SUMMARY
        echo "- Code linting" >> $GITHUB_STEP_SUMMARY
        echo "- Docker image builds" >> $GITHUB_STEP_SUMMARY 